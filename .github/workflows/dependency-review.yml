---
# SPDX-License-Identifier: MIT
# GitHub Dependency Security Review Workflow
name: Dependency Security Review

on: # yamlint disable-line rule:truthy
  pull_request:
    types: [opened, reopened, synchronize]
    paths:
      - requirements*.txt
      - pyproject.toml
      - .github/workflows/dependency-review.yml
      - .github/dependency-review-config.yml

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  dependency-review:
    name: Review Dependencies
    runs-on: ubuntu-latest
    timeout-minutes: 15

    permissions:
      contents: read
      pull-requests: write
      security-events: write

    steps:
      # Step 1: Harden Runner for Security
      - name: ğŸ”’ Harden Runner
        uses: step-security/harden-runner@v2.7.0
        with:
          egress-policy: audit

      # Step 2: Checkout Code
      - name: ğŸ§° Checkout Repository
        uses: actions/checkout@v4.1.5
        with:
          persist-credentials: false
          fetch-depth: 0

      # Step 3: Dependency Review
      - name: ğŸ” Review Dependencies
        id: reviewdeps
        uses: actions/dependency-review-action@v4.3.2
        with:
          comment-summary-in-pr: always
          fail-on-severity: moderate
          deny-licenses: |
            LGPL-2.0
            BSD-2-Clause
            AGPL-1.0
            AGPL-3.0
          retry-on-snapshot-warnings: true
          base-ref: ${{ github.event.pull_request.base.ref }}
          head-ref: ${{ github.event.pull_request.head.ref }}
          config-file: .github/dependency-review-config.yml # Use external config if necessary

      # Step 4: Generate Dependency Report
      - name: ğŸ“Š Generate Dependency Report
        if: always()
        uses: actions/github-script@v7.0.1
        with:
          script: |
            const review = JSON.parse(steps.reviewdeps.outputs.result || '{}');
            let report = '## ğŸ“‹ Dependency Review Summary\n\n';

            if (review.violations?.length > 0) {
              report += '### âš ï¸ Violations Found\n\n';
              review.violations.forEach(v => {
                report += `- **${v.severity}**: ${v.message}\n`;
              });
            } else {
              report += 'âœ… No dependency violations found\n';
            }

            if (review.licenses?.denied?.length > 0) {
              report += '\n### ğŸš« Denied Licenses\n\n';
              review.licenses.denied.forEach(l => {
                report += `- ${l.name} (${l.package})\n`;
              });
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: report
            });

      # Step 5: Add Labels Based on Results
      - name: ğŸ·ï¸ Add Labels
        if: always()
        uses: actions/github-script@v7.0.1
        with:
          script: |
            const labels = [];
            const review = JSON.parse(steps.reviewdeps.outputs.result || '{}');

            if (review.violations?.length > 0 || review.licenses?.denied?.length > 0) {
              labels.push('security-risk');
              if (review.licenses?.denied?.length > 0) {
                labels.push('license-issue');
              }
            } else {
              labels.push('dependency-check-passed');
            }

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels
            });

  notify:
    needs: dependency-review
    if: always() && needs.dependency-review.result != 'skipped'
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ”” Notify on Failure
        if: needs.dependency-review.result == 'failure'
        uses: actions/github-script@v7.0.1
        with:
          script: |
            const message = `âŒ Dependency review failed. Please check the [workflow logs](${context.payload.repository.html_url}/actions/runs/${context.runId}) for details.`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: message
            });
