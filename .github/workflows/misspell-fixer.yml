---
# SPDX-FileCopyrightText: Jürgen Mülbert
# SPDX-License-Identifier: MIT

name: Multi-Language Spell Check

on: # yamllint disable-line rule:truthy
  push:
    branches:
      - main
      - develop
      - release/**
      - resolve-**
    paths-ignore:
      - '**/*.svg'
      - '**/*.png'
      - '**/*.jpg'
      - '**/*.json'
      - LICENSE
      - LICENSES/**

  pull_request:
    types:
      - opened
      - synchronize
      - reopened
    paths-ignore:
      - '**/*.svg'
      - '**/*.png'
      - '**/*.jpg'
      - '**/*.json'
      - LICENSE
      - LICENSES/**

  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  spell-check:
    name: Check Spelling
    if: ${{ github.actor != 'dependabot[bot]' }}
    runs-on: ubuntu-latest
    timeout-minutes: 15

    permissions:
      contents: write
      pull-requests: write

    outputs:
      typos-found: ${{ steps.check-diff.outputs.typos-found }}
      pr-number: ${{ steps.create-pr.outputs.pull-request-number }}

    steps:
      - name: 🔒 Harden Runner
        uses: step-security/harden-runner@63c24ba6bd7ba022e95695ff85de572c04a18142 # v2.7.0
        with:
          egress-policy: audit

      - name: 🧰 Checkout Repository
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1
        with:
          fetch-depth: 0
          persist-credentials: false

      - uses: pnpm/action-setup@eae0cfeb286e66ffb5155f1a79b90583a127a68b # v2.4.1
        with:
          version: 9.12.2
          run_install: true

      - name: 🔍 Install Node and pnpm
        uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af # v4.1.0
        with:
          node-version: 20
          check-latest: true
          cache: 'pnpm'

      - name: 📋 Check Spelling
        id: spell-check
        run: |
          cspell lint > spell-check-en.txt || true

      - name: 🔄 Run Misspell Fixer
        id: misspell
        uses: sobolevn/misspell-fixer-action@8842a5615f83fed75e8a87015e9300a54d049961 # master
        with:
          options: -rsvn

      - name: ✍️ Check for Changes
        id: check-diff
        run: |
          if git diff --quiet; then
            echo "typos-found=false" >> "$GITHUB_OUTPUT"
          else
            echo "typos-found=true" >> "$GITHUB_OUTPUT"
            git diff --name-only > changed_files.txt
          fi

      - name: 📊 Generate Spell Check Report
        id: report
        run: |
          {
            echo "## 📝 Spell Check Results"
            echo ""
            echo "### Spelling Issues:"
          } >> spell_check_report.md

          if [ -s spell-check.txt ]; then
            cat spell-check.txt >> spell_check_report.md
          else
            echo "No issues found" >> spell_check_report.md
          fi

          if [ -f "changed_files.txt" ]; then
            echo "### 🔧 Automated Fixes:" >> spell_check_report.md
            echo "Fixed files:" >> spell_check_report.md
            while IFS= read -r file; do
              echo "- \`$file\`" >> spell_check_report.md
            done < changed_files.txt
          fi

      - name: 🔄 Create Pull Request
        if: steps.check-diff.outputs.typos-found == 'true'
        id: create-pr
        uses: peter-evans/create-pull-request@153407881ec5c347639a548ade7d8ad1d6740e38 # v5.0.2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'docs: fix spelling issues in multiple languages'
          title: 'docs: fix spelling issues in ${{ github.ref_name }}'
          body-file: spell_check_report.md
          branch: 'fix/spelling-${{ github.run_id }}'
          delete-branch: true
          labels: documentation, automated-pr, spelling, i18n
          assignees: ${{ github.actor }}
          reviewers: ${{ github.actor }}

      - name: 📤 Upload Spell Check Report
        if: always()
        uses: actions/upload-artifact@0b2256b8c012f0828dc542b3febcab082c67f72b # v4.3.4
        with:
          name: spell-check-report
          path: |
            spell_check_report.md
            spell-check-en.txt
          retention-days: 7

  notify:
    needs: spell-check
    if: always() && needs.spell-check.outputs.typos-found == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: 📢 Notification
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const message = `### 📝 Multi-Language Spell Check Results

            Spelling issues were found and fixes have been proposed in PR #${{ needs.spell-check.outputs.pr-number }}.

            Please review and merge if appropriate.`;
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: message
            });
