---
# SPDX-FileCopyrightText: JÃ¼rgen MÃ¼lbert
# SPDX-License-Identifier: EUPL-1.2

name: PR Checks

on: # yamlint disable-line rule:truthy
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches:
      - develop
      - feature/**
      - bugfix/**

permissions:
  contents: read

env:
  PYTHON_VERSION_FILE: .python-version
  PACKAGE_NAME: jmbde-python

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  validate:
    name: Validate Dependencies
    runs-on: ubuntu-latest
    timeout-minutes: 15

    permissions:
      contents: read
      pull-requests: write
      security-events: write

    steps:
      - name: ğŸ”’ Harden Runner
        uses: step-security/harden-runner@63c24ba6bd7ba022e95695ff85de572c04a18142 # v2.7
        with:
          egress-policy: audit

      - name: ğŸ“¥ Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0

      - name: ğŸ” Dependency Review
        id: review
        uses: actions/dependency-review-action@3b139cfc5fae8b618d3eae3675e383bb1769c019
        with:
          comment-summary-in-pr: always
          fail-on-severity: moderate
          retry-on-snapshot-warnings: true
          config-file: .github/dependency-review-config.yml
        
      - name: ğŸ“Š Generate Report
        if: always()
        env:
          DEPENDENCY_CHANGES: ${{ steps.review.outputs.dependency-changes }}
          VULNERABLE_CHANGES: ${{ steps.review.outputs.vulnerable-changes }}
          LICENSE_CHANGES: ${{ steps.review.outputs.invalid-license-changes }}
          DENIED_CHANGES: ${{ steps.review.outputs.denied-changes }}
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const outputs = {
              dependencyChanges: JSON.parse(process.env.DEPENDENCY_CHANGES || '[]'),
              vulnerableChanges: JSON.parse(process.env.VULNERABLE_CHANGES || '[]'),
              licenseChanges: JSON.parse(process.env.LICENSE_CHANGES || '[]'),
              deniedChanges: JSON.parse(process.env.DENIED_CHANGES || '[]'),
            };
          
            let report = '## ğŸ“‹ Dependency Review Report\n\n';
          
            // Dependency Summary
            report += `### ğŸ“‘ Summary\n`;
            report += `- Total Changes: ${outputs.dependencyChanges.length}\n`;
            report += `- Vulnerable Changes: ${outputs.vulnerableChanges.length}\n`;
            report += `- License Issues: ${outputs.licenseChanges.length}\n`;
            report += `- Denied Changes: ${outputs.deniedChanges.length}\n\n`;
          
            // Vulnerabilities
            if (outputs.vulnerableChanges.length > 0) {
              report += '### âš ï¸ Vulnerable Changes\n\n';
              outputs.vulnerableChanges.forEach(change => {
              report += `- **${change.package.name}@${change.package.version}**: ${change.advisory.title}\n`;
              report += `  - Severity: ${change.advisory.severity}\n`;
              report += `  - Advisory: [${change.advisory.url}](${change.advisory.url})\n\n`;
              });
            } else {
              report += '### âœ… No Vulnerable Changes Found\n\n';
            }
          
            // License Issues
            if (outputs.licenseChanges.length > 0) {
              report += '### ğŸš« License Issues\n\n';
              outputs.licenseChanges.forEach(change => {
              report += `- **${change.package.name}@${change.package.version}**: ${change.license}\n`;
              report += `  - Allowed Licenses: ${change.allowedLicenses.join(', ')}\n\n`;
              });
            } else {
              report += '### âœ… No License Issues Found\n\n';
            }
          
            // Denied Changes
            if (outputs.deniedChanges.length > 0) {
              report += '### âŒ Denied Changes\n\n';
              outputs.deniedChanges.forEach(change => {
              report += `- **${change.package.name}@${change.package.version}**: ${change.reason}\n`;
              });
            } else {
              report += '### âœ… No Denied Changes Found\n\n';
            }
          
            // Post Report
            if (context.payload.pull_request) {
              await github.rest.issues.createComment({
                ...context.repo,
                issue_number: context.payload.pull_request.number,
                body: report
              });
            }
          
      - name: ğŸ·ï¸ Update Labels
        if: always()
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:       
          script: |
            try {
              const reviewPassed = '${{ steps.review.outcome }}' === 'success';
              const results = JSON.parse('${{ steps.review.outputs.result || '{}' }}');

              const labels = [];

              // Review status labels
              if (reviewPassed) {
                labels.push('dependency-check-passed');
              } else {
                labels.push('dependency-check-failed');
              }

              // Specific issue labels
              if (results.violations?.length > 0) {
                labels.push('security-issues');
              }
              if (results.licenses?.denied?.length > 0) {
                labels.push('license-issues');
              }

              // Additional status labels
              if (reviewPassed && !results.alerts?.length) {
                labels.push('ready-for-review');
              } else {
                labels.push('needs-work');
              }

              // Remove existing labels first
              const existingLabels = [
                'dependency-check-passed',
                'dependency-check-failed',
                'security-issues',
                'license-issues',
                'ready-for-review',
                'needs-work'
              ];

              for (const label of existingLabels) {
                try {
                  await github.rest.issues.removeLabel({
                    ...context.repo,
                    issue_number: context.payload.pull_request.number,
                    name: label
                  });
                } catch (e) {
                  // Ignore errors from non-existent labels
                  if (e.status !== 404) throw e;
                }
              }

              // Add new labels
              if (labels.length > 0) {
                await github.rest.issues.addLabels({
                  ...context.repo,
                  issue_number: context.payload.pull_request.number,
                  labels: labels
                });
              }

            } catch (error) {
              core.warning(`Error updating labels: ${error.message}`);
            }

  validate-pr:
    name: Validate PR
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    outputs:
      title-valid: ${{ steps.check-title.outputs.valid }}
      body-valid: ${{ steps.check-body.outputs.valid }}

    permissions:
      issues: write
      pull-requests: write

    steps:
      - name: ğŸ”’ Harden Runner
        uses: step-security/harden-runner@63c24ba6bd7ba022e95695ff85de572c04a18142 # v2.7.0
        with:
          egress-policy: audit

      - name: ğŸ” Check PR Title
        id: check-title
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const { title } = context.payload.pull_request;
            const conventionalCommitRegex = /^(build|chore|ci|docs|feat|fix|perf|refactor|revert|style|test)\b(\([\w-]+\))?: .{1,100}$/;

            const isValid = conventionalCommitRegex.test(title);
            core.setOutput('valid', isValid);

            if (!isValid) {
              const validTypes = ['build', 'chore', 'ci', 'docs', 'feat', 'fix', 'perf', 'refactor', 'revert', 'style', 'test'];
              await github.rest.issues.createComment({
                ...context.repo,
                issue_number: context.issue.number,
                body: `## âŒ Invalid PR Title

                Please follow [Conventional Commits](https://www.conventionalcommits.org/) format:
                \`type(scope): description\`

                Valid types:
                ${validTypes.map(type => `- \`${type}\``).join('\n')}

                Examples:
                - \`feat(auth): add login functionality\`
                - \`fix(api): handle null response\`
                `
              });
            }

      - name: ğŸ“ Check PR Body
        id: check-body
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const body = context.payload.pull_request.body || '';
            const requiredSections = ['Description', 'Related Issue', 'Testing'];
            const missingTemplates = [];

            for (const section of requiredSections) {
              if (!body.includes(`### ${section}`)) {
                missingTemplates.push(section);
              }
            }

            const isValid = missingTemplates.length === 0;
            core.setOutput('valid', isValid);

            if (!isValid) {
              await github.rest.issues.createComment({
                ...context.repo,
                issue_number: context.issue.number,
                body: `## âŒ Incomplete PR Description

                Missing sections:
                ${missingTemplates.map(section => `- [ ] ${section}`).join('\n')}

                Please use our PR template.`
              });
            }

      - name: ğŸ·ï¸ Update Labels
        if: always()
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const titleValid = '${{ steps.check-title.outputs.valid }}' === 'true';
            const bodyValid = '${{ steps.check-body.outputs.valid }}' === 'true';

            const labels = [];
            if (titleValid && bodyValid) {
              labels.push('ready-for-review');
            } else {
              labels.push('needs-work');
            }

            await github.rest.issues.addLabels({
              ...context.repo,
              issue_number: context.issue.number,
              labels
            });

      - name: ğŸ” Check Commit Messages
        id: commitlint
        run: |
          npm install --global @commitlint/cli @commitlint/config-conventional
          echo "module.exports = {extends: ['@commitlint/config-conventional']};" > commitlint.config.js

          git fetch origin ${{ github.event.pull_request.base.ref }} --depth=1

          COMMITS=$(git rev-list ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }})

          EXIT_CODE=0
          INVALID_COMMITS=""

          for commit in $COMMITS; do
            if ! git log -1 --format="%B" $commit | commitlint; then
              EXIT_CODE=1
              INVALID_COMMITS="$INVALID_COMMITS\n$(git log -1 --format="%h: %s" $commit)"
            fi
          done

          if [ $EXIT_CODE -ne 0 ]; then
            echo "invalid_commits<<EOF" >> $GITHUB_OUTPUT
            echo -e "$INVALID_COMMITS" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

          exit $EXIT_CODE

      - name: ğŸ’¬ Add Commit Lint Comment
        if: always() && steps.commitlint.outcome != 'skipped'
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const outcome = '${{ steps.commitlint.outcome }}';
            const invalidCommits = `${{ steps.commitlint.outputs.invalid_commits }}`;

            let message = '## ğŸ“ Commit Message Check\n\n';

            if (outcome === 'success') {
              message += 'âœ… All commit messages follow the conventional commits standard.\n';
            } else {
              message += 'âŒ Some commit messages do not follow the conventional commits standard.\n\n';
              message += '### Invalid Commits:\n```\n' + invalidCommits + '\n```\n\n';
              message += 'Please follow the [Conventional Commits](https://www.conventionalcommits.org/) format:\n';
              message += '```\n<type>[optional scope]: <description>\n\n[optional body]\n\n[optional footer(s)]\n```\n\n';
              message += 'Valid types:\n';
              message += '- feat: New feature\n';
              message += '- fix: Bug fix\n';
              message += '- docs: Documentation changes\n';
              message += '- style: Code style changes\n';
              message += '- refactor: Code refactoring\n';
              message += '- perf: Performance improvements\n';
              message += '- test: Adding or updating tests\n';
              message += '- chore: Maintenance tasks\n';
            }

            await github.rest.issues.createComment({
              ...context.repo,
              issue_number: context.issue.number,
              body: message
            });

      - name: ğŸ·ï¸ Update Labels
        if: always() && steps.commitlint.outcome != 'skipped'
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const outcome = '${{ steps.commitlint.outcome }}';

            const labelsToAdd = [];
            const labelsToRemove = [];

            if (outcome === 'success') {
              labelsToAdd.push('commits-validated');
              labelsToRemove.push('invalid-commits');
            } else {
              labelsToAdd.push('invalid-commits');
              labelsToRemove.push('commits-validated');
            }

            // Add labels
            if (labelsToAdd.length > 0) {
              await github.rest.issues.addLabels({
                ...context.repo,
                issue_number: context.issue.number,
                labels: labelsToAdd
              });
            }

            // Remove labels
            for (const label of labelsToRemove) {
              try {
                await github.rest.issues.removeLabel({
                  ...context.repo,
                  issue_number: context.issue.number,
                  name: label
                });
              } catch (error) {
                if (error.status !== 404) throw error;
              }
            }

  test:
    name: Python ${{ matrix.python-version }} on ${{ matrix.os }}
    needs: validate
    runs-on: ${{ matrix.os }}
    timeout-minutes: 30

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: ['3.9', '3.10', '3.11', '3.12']
        exclude:
          - os: macos-latest
            python-version: '3.9'
          - os: windows-latest
            python-version: '3.9'

    outputs:
      coverage: ${{ steps.coverage.outputs.percentage }}

    steps:
      - name: ğŸ”’ Harden Runner
        uses: step-security/harden-runner@63c24ba6bd7ba022e95695ff85de572c04a18142 # v2.7.0
        with:
          egress-policy: audit

      - name: ğŸ§° Checkout Repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: âš™ï¸ Setup Python
        uses: actions/setup-python@0b93645e9fea7318ecaed2b359559ac225c90a2b # v5.3.0
        with:
          python-version: ${{ matrix.python-version }}
          cache: pip
          cache-dependency-path: |
            .github/workflows/requirements.txt
            pyproject.toml

      - name: ğŸ› ï¸ Install Dependencies
        run: |
          pip install -r .github/workflows/requirements.txt

      - name: ğŸ¨ Setup Qt Dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libxcb-xinerama0 \
            libxcb-icccm4 \
            libxcb-image0 \
            libxcb-keysyms1 \
            libxcb-randr0 \
            libxcb-render-util0 \
            libxcb-shape0 \
            libxcb-xkb1 \
            libxkbcommon-x11-0 \
            libegl1

      - name: âš™ï¸ Setup Pre-commit
        run: |
          hatch run lint:prcommit

      - name: ğŸ§ª Run Tests
        run: hatch run test:test

      - name: ğŸ“Š Generate Coverage
        id: coverage
        run: |
          hatch run test:cov
          COVERAGE=$(coverage report | grep TOTAL | awk '{print $4}' | sed 's/%//')
          echo "percentage=${COVERAGE}" >> "$GITHUB_OUTPUT"

          if [ "${COVERAGE}" -lt "80" ]; then
            echo "::warning::Coverage ${COVERAGE}% is below threshold of 80%"
          fi

      - name: ğŸ“¤ Upload Coverage
        uses: codecov/codecov-action@13ce06bfc6bbe3ecf90edbbf1bc32fe5978ca1d3 # v5.3.1
        with:
          files: ./coverage.xml
          flags: ${{ matrix.os }},python-${{ matrix.python-version }}
          fail_ci_if_error: true

      - name: ğŸ“¦ Store Test Results
        if: always()
        uses: actions/upload-artifact@65c4c4a1ddee5b72f698fdd19549f0f0fb45cf08 # v4.6.0
        with:
          name: test-results-${{ matrix.os }}-${{ matrix.python-version }}
          path: |
            .coverage
            coverage.xml
            htmlcov/
          retention-days: 7

  lint:
    name: Lint & Format
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: test

    permissions:
      security-events: write

    steps:
      - name: ğŸ”’ Harden Runner
        uses: step-security/harden-runner@63c24ba6bd7ba022e95695ff85de572c04a18142 # v2.7.0
        with:
          egress-policy: audit

      - name: ğŸ§° Checkout Repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: âš™ï¸ Setup Python
        uses: actions/setup-python@0b93645e9fea7318ecaed2b359559ac225c90a2b # v5.3.0
        with:
          python-version-file: ${{ env.PYTHON_VERSION_FILE }}
          cache: pip
          cache-dependency-path: |
            .github/workflows/requirements.txt
            pyproject.toml

      - name: ğŸ› ï¸ Install Dependencies
        run: |
          pip install -r .github/workflows/requirements.txt

      - name: ğŸ“¦ Cache Pre-commit
        uses: actions/cache@1bd1e32a3bdc45362d1e726936510720a7c30a57 # v4.2.0
        with:
          path: ~/.cache/pre-commit
          key: pre-commit-${{ hashFiles('.pre-commit-config.yaml') }}
          restore-keys: |
            pre-commit-

      - name: âš™ï¸ Install pre-commit
        run: hatch env create lint

      - name: âœ¨ Run All Checks
        id: checks
        run: |
          echo "Running style checks..."
          hatch run lint:style || echo "style=failed" >> "$GITHUB_OUTPUT"

          echo "Running type checks..."
          hatch run lint:typing || echo "typing=failed" >> "$GITHUB_OUTPUT"

          echo "Running security checks..."
          hatch run lint:security || echo "security=failed" >> "$GITHUB_OUTPUT"

          echo "Running license checks..."
          hatch run lint:license || echo "license=failed" >> "$GITHUB_OUTPUT"

          echo "Running pre-commit checks..."
          hatch run lint:prcommit || echo "precommit=failed" >> "$GITHUB_OUTPUT"

      - name: ğŸ“Š Generate Report
        if: always()
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const steps = {
              style: '${{ steps.checks.outputs.style }}' !== 'failed',
              typing: '${{ steps.checks.outputs.typing }}' !== 'failed',
              security: '${{ steps.checks.outputs.security }}' !== 'failed',
              license: '${{ steps.checks.outputs.license }}' !== 'failed',
              precommit: '${{ steps.checks.outputs.precommit }}' !== 'failed'
            };

            let summary = `## ğŸ” Code Quality Check Results\n\n`;

            summary += `### Check Status\n`;
            summary += `- Style Checks: ${steps.style ? 'âœ…' : 'âŒ'}\n`;
            summary += `- Type Checks: ${steps.typing ? 'âœ…' : 'âŒ'}\n`;
            summary += `- Security Checks: ${steps.security ? 'âœ…' : 'âŒ'}\n`;
            summary += `- License Checks: ${steps.license ? 'âœ…' : 'âŒ'}\n`;
            summary += `- Pre-commit Checks: ${steps.precommit ? 'âœ…' : 'âŒ'}\n\n`;

            if (Object.values(steps).every(Boolean)) {
              summary += `### âœ… All checks passed successfully!\n`;
            } else {
              summary += `### âš ï¸ Some checks failed. Please review the logs for details.\n`;

              if (!steps.style) {
                summary += `\n#### Style Issues\n`;
                summary += `Run \`hatch run lint:format\` locally to fix style issues.\n`;
              }

              if (!steps.typing) {
                summary += `\n#### Type Issues\n`;
                summary += `Review type annotations and run \`hatch run lint:typing\` locally.\n`;
              }

              if (!steps.security) {
                summary += `\n#### Security Issues\n`;
                summary += `Review security alerts and run \`hatch run lint:security\` locally.\n`;
              }

              if (!steps.license) {
                summary += `\n#### License Issues\n`;
                summary += `Review license alerts and run \`hatch run lint:license\` locally.\n`;
              }

              if (!steps.precommit) {
                summary += `\n#### Pre-Commit Issues\n`;
                summary += `Review pre-commit alerts and run \`hatch run lint:prcommit\` locally.\n`;
              }
            }

            if (context.payload.pull_request) {
              await github.rest.issues.createComment({
                ...context.repo,
                issue_number: context.payload.pull_request.number,
                body: summary
              });
            }

      - name: ğŸ·ï¸ Update Labels
        if: github.event_name == 'pull_request'
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const steps = {
              style: '${{ steps.checks.outputs.style }}' !== 'failed',
              typing: '${{ steps.checks.outputs.typing }}' !== 'failed',
              security: '${{ steps.checks.outputs.security }}' !== 'failed',
              license: '${{ steps.checks.outputs.license }}' !== 'failed',
              precommit: '${{ steps.checks.outputs.precommit }}' !== 'failed'
            };

            const labels = [];

            if (Object.values(steps).every(Boolean)) {
              labels.push('quality-checks-passed');
            } else {
              if (!steps.style) labels.push('needs-formatting');
              if (!steps.typing) labels.push('needs-types');
              if (!steps.security) labels.push('security-review');
            }

            await github.rest.issues.addLabels({
              ...context.repo,
              issue_number: context.payload.pull_request.number,
              labels: labels
            });

      - name: âŒ Check Failure
        if: failure()
        run: exit 1

  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest
    needs: validate

    steps:
      - name: ğŸ”’ Harden Runner
        uses: step-security/harden-runner@63c24ba6bd7ba022e95695ff85de572c04a18142 # v2.7.0
        with:
          egress-policy: audit

      - name: ğŸ§° Checkout Repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: âš™ï¸ Setup Python
        uses: actions/setup-python@0b93645e9fea7318ecaed2b359559ac225c90a2b # v5.3.0
        with:
          python-version-file: ${{ env.PYTHON_VERSION_FILE }}
          cache: pip
          cache-dependency-path: |
            .github/workflows/requirements.txt
            pyproject.toml

      - name: ğŸ”§ Install Dependencies
        run: |
          pip install -r .github/workflows/requirements.txt

      - name: ğŸ” Security Analysis
        run: |
          hatch run security:scan
          hatch run security:audit

      - name: ğŸ“Š Complexity Check
        run: |
          hatch run lint:radon_quality
        continue-on-error: true

      - name: ğŸ¯ Run Quality Checks
        id: quality
        run: |
          # Run all checks and collect metrics
          echo "::group::Style Checks"
          hatch run lint:style
          echo "::endgroup::"

          echo "::group::Type Checks"
          hatch run lint:typing
          echo "::endgroup::"

          echo "::group::Security Checks"
          hatch run security:all
          echo "::endgroup::"

      - name: ğŸ“ Generate Quality Report
        if: always()
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const metrics = {
              style: '${{ steps.quality.outputs.style }}' === 'success',
              typing: '${{ steps.quality.outputs.typing }}' === 'success',
              security: '${{ steps.quality.outputs.security }}' === 'success',
            };

            let report = `## ğŸ“Š Code Quality Report\n\n`;

            // Add status badges
            report += `### Status\n`;
            report += `- Style: ${metrics.style ? 'âœ…' : 'âŒ'}\n`;
            report += `- Type Safety: ${metrics.typing ? 'âœ…' : 'âŒ'}\n`;
            report += `- Security: ${metrics.security ? 'âœ…' : 'âŒ'}\n`;

            // Add recommendations if any checks failed
            if (Object.values(metrics).includes(false)) {
              report += `### Recommendations\n`;
              if (!metrics.style) {
                report += `- Run \`hatch run lint:format\` locally\n`;
              }
              if (!metrics.typing) {
                report += `- Fix type annotations\n`;
              }
              if (!metrics.security) {
                report += `- Review security warnings\n`;
              }
              if (!metrics.docs) {
                report += `- Improve documentation coverage\n`;
              }
            }

            // Add to PR comments
            if (context.payload.pull_request) {
              await github.rest.issues.createComment({
                ...context.repo,
                issue_number: context.payload.pull_request.number,
                body: report
              });
            }

      - name: ğŸ·ï¸ Update Labels
        if: github.event_name == 'pull_request'
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.17
        with:
          script: |
            const quality = '${{ steps.quality.outcome }}' === 'success';
            const labels = quality ? ['quality-checks-passed'] : ['needs-quality-fixes'];

            await github.rest.issues.addLabels({
              ...context.repo,
              issue_number: context.payload.pull_request.number,
              labels: labels
            });

      - name: âŒ Check Status
        if: steps.quality.outcome != 'success'
        run: exit 1

  security:
    name: Security Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: test

    steps:
      - name: ğŸ”’ Harden Runner
        uses: step-security/harden-runner@63c24ba6bd7ba022e95695ff85de572c04a18142 # v2.7.0
        with:
          egress-policy: audit

      - name: ğŸ§° Checkout Repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: âš™ï¸ Setup Python
        uses: actions/setup-python@0b93645e9fea7318ecaed2b359559ac225c90a2b # v5.3.0
        with:
          python-version-file: ${{ env.PYTHON_VERSION_FILE }}
          cache: pip
          cache-dependency-path: |
            .github/workflows/requirements.txt
            pyproject.toml

      - name: ğŸ› ï¸ Install Dependencies
        run: |
          pip install -r .github/workflows/requirements.txt

      - name: ğŸ›¡ï¸ Security Checks
        run: |
          hatch run security:scan
          hatch run security:audit

  spell-check:
    name: Spell Check
    runs-on: ubuntu-latest
    needs: lint
    timeout-minutes: 15

    steps:
      - name: ğŸ”’ Harden Runner
        uses: step-security/harden-runner@63c24ba6bd7ba022e95695ff85de572c04a18142 # v2.7.0
        with:
          egress-policy: audit

      - name: ğŸ§° Checkout Repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: âš™ï¸ Setup Python
        uses: actions/setup-python@0b93645e9fea7318ecaed2b359559ac225c90a2b # v5.3.0
        with:
          python-version-file: ${{ env.PYTHON_VERSION_FILE }}
          cache: pip
          cache-dependency-path: |
            .github/workflows/requirements.txt
            pyproject.toml

      - name: ğŸ”§ Install Dependencies
        run: |
          pip install -r requirements.txt

      - name: ğŸ” Run Spell Checks
        id: spell-check
        run: |
          echo "Running codespell..."
          hatch env create lint
          hatch run lint:spell > codespell.txt || true

          # Check if any changes were made
          if git diff --quiet; then
            echo "changes=false" >> "$GITHUB_OUTPUT"
          else
            echo "changes=true" >> "$GITHUB_OUTPUT"
            git diff --name-only > changed_files.txt
          fi

      - name: ğŸ“Š Generate Report
        if: always()
        run: |
          {
            echo "## ğŸ“ Spell Check Report"
            echo ""
            echo "### CodeSpell Results:"
            if [ -s codespell.txt ]; then
              cat codespell.txt
            else
              echo "No issues found"
            fi

            if [ -f "changed_files.txt" ]; then
              echo -e "\n### Files with Automatic Fixes:"
              while IFS= read -r file; do
                echo "- \`$file\`"
              done < changed_files.txt
            fi
          } > spell_check_report.md

      - name: ğŸ’¬ Add PR Comment
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('spell_check_report.md', 'utf8');

            await github.rest.issues.createComment({
              ...context.repo,
               issue_number: context.payload.pull_request.number,
               body: report
            });

      - name: ğŸ”„ Create Fix PR
        if: steps.spell-check.outputs.changes == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'docs: fix spelling issues'
          title: 'ğŸ“ Fix spelling issues'
          body-path: spell_check_report.md
          branch: fix/spelling-${{ github.run_id }}
          delete-branch: true
          labels: |
            documentation
            automated-pr
            spelling

      - name: ğŸ“¦ Upload Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: spell-check-report
          path: |
            spell_check_report.md
            codespell.txt
            retention-days: 7

  docs:
    name: Documentation
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: test

    steps:
      - name: ğŸ”’ Harden Runner
        uses: step-security/harden-runner@63c24ba6bd7ba022e95695ff85de572c04a18142 # v2.7.0
        with:
          egress-policy: audit

      - name: ğŸ§° Checkout Repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: âš™ï¸ Setup Python
        uses: actions/setup-python@0b93645e9fea7318ecaed2b359559ac225c90a2b # v5.3.0
        with:
          python-version-file: ${{ env.PYTHON_VERSION_FILE }}
          cache: pip
          cache-dependency-path: |
            '**/pyproject.toml'
            requirements.txt

      - name: ğŸ› ï¸ Install Dependencies
        run: |
          pip install -r .github/workflows/requirements.txt
          sudo apt-get update
          sudo apt-get install -y graphviz

      - name: ğŸ“š Build Docs
        id: build
        run: |
          hatch run docs:build
          echo "doc-files=$(find site -type f -print | wc -l)" >> "$GITHUB_OUTPUT"

      - name: ğŸ” Check Links
        run: |
          hatch run docs:validate-links
          echo "Checking internal links..."
          broken_links=$(find site -type f -name "*.html" -exec grep -l "page-not-found" {} \;)
          if [ ! -z "$broken_links" ]; then
            echo "::error::Found broken internal links in: $broken_links"
            exit 1
          fi

      - name: ğŸ“Š Generate Docs Report
        id: report
        run: |
          {
            echo "TOTAL_FILES=$(find site -type f -print | wc -l)"
            echo "HTML_FILES=$(find site -type f -name "*.html" | wc -l)"
            echo "API_FILES=$(find site/api -type f -name "*.html" | wc -l)"
            echo "SIZE=$(du -sh site | cut -f1)"
          } >> "$GITHUB_OUTPUT"

      - name: ğŸ” Quality Check
        run: |
          python docs/scripts/doc_quality.py
        continue-on-error: true # Optional: Don't fail the build for quality issues

      - name: ğŸ“Š Translation Status
        id: translations
        run: |
          missing_translations=$(find docs/i18n -type f -name "*.md" | wc -l)
          total_docs=$(find docs/en -type f -name "*.md" | wc -l)
          echo "translation_coverage=$((missing_translations * 100 / total_docs))" >> "$GITHUB_OUTPUT"

      - name: ğŸ’¬ Add Quality Report
        if: github.event_name == 'pull_request'
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const summary = `## ğŸ“š Documentation Quality Report

            ### Translation Coverage
            - Coverage: ${{ steps.translations.outputs.translation_coverage }}%

            ### Quality Checks
            - See build logs for detailed quality report

            ### Languages
            - ğŸ‡¬ğŸ‡§ English (base)
            - ğŸ‡©ğŸ‡ª German
            - ğŸ‡®ğŸ‡¹ Italian
            - ğŸ‡ªğŸ‡¸ Spanish
            `;

            await github.rest.issues.createComment({
              ...context.repo,
              issue_number: context.payload.pull_request.number,
              body: summary
            });

      - name: ğŸ“¦ Store Documentation
        uses: actions/upload-artifact@65c4c4a1ddee5b72f698fdd19549f0f0fb45cf08 # v4.6.0
        with:
          name: documentation-preview
          path: site/
          retention-days: 7

      - name: ğŸ’¬ Add PR Comment
        if: github.event_name == 'pull_request'
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const summary = `## ğŸ“š Documentation Preview

            ### Statistics
            - Files Generated: ${{ steps.build.outputs.doc-files }}
            - Status: âœ… Build Successful

            ### Preview
            Documentation preview is available in the artifacts.

            ### Validation
            - âœ… Documentation built successfully
            - âœ… Links validated
            - âœ… API documentation generated
            `;

            await github.rest.issues.createComment({
              ...context.repo,
              issue_number: context.payload.pull_request.number,
              body: summary
            });

  report:
    name: Generate Report
    if: always()
    needs: [validate, validate-pr, test, lint, security, spell-check, docs]
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“Š Process Results
        if: always()
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const summary = `## ğŸ” PR Check Results

            ### Test Coverage: ${{ needs.test.outputs.coverage }}%
            - Validate: ${needs.validate.result}
            - Validate-PR: ${needs.validate-pr.result}
            - Status: ${needs.test.result}
            - Linting: ${needs.lint.result}
            - Security: ${needs.security.result}
            - Spell-Check: ${needs.spell-check.result}
            - Docs: ${needs.docs.result}

            ### Details
            - [Coverage Report](https://codecov.io/gh/${{ github.repository }})
            - [Test Results](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            `;

            if (context.payload.pull_request) {
              await github.rest.issues.createComment({
                ...context.repo,
                issue_number: context.payload.pull_request.number,
                body: summary
              });
            }

      - name: ğŸš¨ Check Status
        if: needs.test.result != 'success' || needs.lint.result != 'success' || needs.security.result != 'success'
        run: exit 1
