shallow_clone: false

image:
  - Visual Studio 2019

# What Python version is installed where:
# http://www.appveyor.com/docs/installed-software#python

environment:
  global:
    PYTHONUNBUFFERED: 1
    MINICONDA: C:\\Miniconda3-x64

    # SDK v7.0 MSVC Express 2008's SetEnv.cmd script will fail if the
    # /E:ON and /V:ON options are not enabled in the batch script intepreter
    # See: http://stackoverflow.com/a/13751649/163740
    CMD_IN_ENV: "cmd /E:ON /V:ON /C .\\appveyor\\run_with_env.cmd"

  matrix:
    - PYTHON: "C:\\Python36"
      PYTHON_VERSION: "3.6.x" # currently 3.6.6
      PYTHON_ARCH: "32"

    - PYTHON: "C:\\Python36-x64"
      PYTHON_VERSION: "3.6.x" # currently 3.6.6
      PYTHON_ARCH: "64"

    - PYTHON: "C:\\Python37"
      PYTHON_VERSION: "3.7.x" # currently 3.7.1
      PYTHON_ARCH: "32"

    - PYTHON: "C:\\Python37-x64"
      PYTHON_VERSION: "3.7.x" # currently 3.7.1
      PYTHON_ARCH: "64"

    - PYTHON: "C:\\Python38"
      PYTHON_VERSION: "3.8.x" # currently 3.7.1
      PYTHON_ARCH: "32"

    - PYTHON: "C:\\Python38-x64"
      PYTHON_VERSION: "3.8.x" # currently 3.7.1
      PYTHON_ARCH: "64"

  init:
    - "%PYTHON%/python -V"
    - mkdir C:\Users\appveyor\.conda
    - call %MINICONDA%\Scripts\activate.bat
    - python -V
    - conda config --set always_yes yes --set changeps1 no
    - conda update -q conda
    - conda config --add channels conda-forge
    - conda update --all

install:
  - conda env create python=%PYVER% -f environment.yml
  - conda activate jmbde-python

  - conda update --all
  - conda list # for debug reason

# Not a .NET project, we build in the install step instead
build: false

test_script:
  - py.test tests/basic_test.py --cov=codecov
  # - "python -m tox -e %TOX_ENV%"

after_test:
  - rm -rf tests/coverages
  - if not exist dist mkdir dist
  - if exist .coverage (cp .coverage dist\) else (echo no .coverage)
  - codecov
  - if exist coverage.xml (cp coverage.xml dist\) else (echo no coverage.xml)
  - "python setup.py bdist_wheel"
  - conda install -c conda-forge codecov
  - conda install conda-build anaconda-client pytest pytest-cov
  - codecov
  - coveralls
  - conda build recipe --no-test
  - conda install --use-local jmbde
  - conda info -a

artifacts:
  - path: dist\*

on_success:
  - codecov
  - CODECOV_TOKEN="71a0c88c-1ddb-499d-be40-b1f6b0db78a3"
